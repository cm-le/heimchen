%script(src='#{static_path(@conn, "/js/typeahead.bundle.min.js")}')

.row.page-header
  .col-xs-6
    %h1 Eintrag anzeigen
  .float-xs-right.col-xs-3
    %form(action="#{item_path(@conn, :add_keyword, @id)}", method="get")
      #prefetch-keywords
        .input-group
          %input.typeahead.form-control(type="text", name="keyword", placeholder="Stichwort")
          %span.input-group-btn
            %button.btn.btn-outline-primary(type="submit")
              %i.fa.fa-plus
    %script
      var bloodHound = new Bloodhound({ datumTokenizer: Bloodhound.tokenizers.whitespace,
      queryTokenizer: Bloodhound.tokenizers.whitespace,
      =raw("prefetch: '../../keyword/keywords?for=#{@item.itemtype.sid}'});")
      $('#prefetch-keywords .typeahead').typeahead(null, {name: 'keyword', source: bloodHound });
      bloodHound.clearPrefetchCache(); bloodHound.initialize();
  .float-xs-right
    %a.btn.btn-outline-primary(href="#{item_path(@conn, :edit, @id)}")
      %i.fa.fa-edit
      Bearbeiten
  .float-xs-right.col-xs-1
    %a.btn.btn-outline-primary(href="#{image_path(@conn, :new, item_id: @id)}")
      %i.fa.fa-upload

.row
  .col-xs-12.col-sm-6
    %h4="#{@item.name} (#{@item.itemtype.name})"
    %p=@item.comment
    %dl
      - if @item.received_by do
        %dt Erhalten von
        %dd
          =link(Heimchen.Person.name(@item.received_by), to: person_path(@conn, :show, @item.received_by.id))
          %i=@item.received_comment
      - if @item.inventory do
        %dt Inventarnummer
        %dd= @item.inventory

  .col-xs-12.col-sm-6
    %h4 Stichw√∂rter  
    %ul
      - for c <- Enum.uniq(Enum.map(@item.keywords, fn(k) -> k.category end)) do
        %li
          %b=c
          %ul
            - for k <- Enum.filter(@item.keywords, fn(k) -> k.category == c end) do
              %li
                = k.name
                %a{href="#{item_path(@conn, :delete_keyword, @item.id, k.id)}"}
                  %i.fa.fa-remove

.card-columns
  -for it <- @item.imagetags do
    .card(style="width: 160px;margin:5px;")
      %a(href="#{image_path(@conn, :show, it.image_id)}")
        .canvas-container(id="#{it.id}_cc")
          %img.card-img-top.img-fluid(src="#{image_path(@conn, :image, it.image_id, 1)}",id="#{it.id}_img", onload="attach_canvas('#{it.id}_cc',#{elem(Poison.encode(it.marks),1)}, '#ff0000');")
      .card-block
        %p.card-subtitle
          %small.text-muted
            =it.comment
      .card-footer
        %small.text-muted
          %a(href="#{image_path(@conn, :edit_imagetag, it.id)}")
            %i.fa.fa-edit
            Edit
        %small.text-muted.float-xs-right
          %a(href="#{image_path(@conn, :del_imagetag, it.id)}")
            %i.fa.fa-remove


.float-xs-right.footer
  %i.small
    Zuletzt bearbeitet am
    =show_timestamp(@item.updated_at)
    von
    =Heimchen.User.name(@item.user)
